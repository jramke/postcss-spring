const postcss = require("postcss");
const { equal } = require("node:assert");
const { test } = require("node:test");

const plugin = require("./");

async function run(input, output, opts = {}) {
    let result = await postcss([plugin(opts)]).process(input, {
        from: undefined,
    });
    equal(result.css, output);
    equal(result.warnings().length, 0);
}

test("generates correct easing curve", async () => {
    await run(
        "a{ transition-timing-function: spring-bounce(0) }", 
        "a{ transition-timing-function: linear(0, 0.001 0.44%, 0.0045 0.94%, 0.0195 2.03%, 0.0446 3.19%, 0.0811 4.5%, 0.1598 6.82%, 0.3685 12.34%, 0.4693 15.17%, 0.5663, 0.6498 21.27%, 0.7215 24.39%, 0.7532 25.98%, 0.7829 27.65%, 0.8105, 0.8349 31.14%, 0.8573 32.95%, 0.8776 34.84%, 0.8964 36.87%, 0.9136 39.05%, 0.929 41.37%, 0.9421 43.77%, 0.9537 46.38%, 0.9636 49.14%, 0.9789 55.31%, 0.9888 62.35%, 0.9949 71.06%, 0.9982 82.52%, 0.9997 99.94%); --_spring-duration-multiplier-0: 1.66 }", 
        {}
    );
});

test("generates correct arbitrary easing curve", async () => {
    await run(
        "a{ transition-timing-function: spring-bounce(77) }", 
        "a{ transition-timing-function: linear(0, 0.0032, 0.0127, 0.0288, 0.0508, 0.0793, 0.1153 1.52%, 0.2063 2.08%, 0.2995 2.56%, 0.4145 3.09%, 0.8473 4.9%, 1.0091, 1.1523 6.33%, 1.2651 6.99%, 1.3121, 1.3534, 1.3881, 1.4169, 1.44, 1.4573, 1.4689, 1.475 9.53%, 1.4758, 1.4733, 1.4673, 1.458, 1.4452, 1.4289 11.12%, 1.3848 11.71%, 1.3401 12.21%, 1.283 12.77%, 1.0708 14.64%, 0.9925, 0.9241 16.09%, 0.87 16.76%, 0.83, 0.8009 18%, 0.7905, 0.7825, 0.777, 0.774 19.23%, 0.7746, 0.7818 20.28%, 0.7955 20.83%, 0.8164 21.42%, 0.8379 21.93%, 0.8651 22.48%, 0.9665 24.37%, 1.0037, 1.0362 25.81%, 1.062 26.49%, 1.0808, 1.0945, 1.1034, 1.1075 28.94%, 1.1073 29.45%, 1.104 29.99%, 1.0974 30.55%, 1.0875 31.14%, 1.0642 32.21%, 0.9982 34.82%, 0.9827 35.54%, 0.9706 36.2%, 0.9617, 0.9552, 0.9509, 0.9489 38.62%, 0.9504 39.68%, 0.9582 40.84%, 0.9693 41.92%, 1.0009 44.55%, 1.014 45.93%, 1.0213, 1.0243 48.3%, 1.0239 49.24%, 1.0212 50.24%, 0.995 55.23%, 0.9904 56.61%, 0.9885 57.96%, 0.9899 59.95%, 1.0023 64.92%, 1.0055 67.63%, 1.0048 69.7%, 0.999 74.57%, 0.9974 77.17%, 1.0012 86.83%, 0.9996 100%); --_spring-duration-multiplier-0: 5.285 }", 
        {}
    );
});

test("generates correct duration", async () => {
    await run(
        "a{ transition-duration: spring-duration(100) }", 
        "a{ transition-duration: calc(100ms * var(--_spring-duration-multiplier-0)) }", 
        {}
    );
});

test("generates correct arbitrary duration", async () => {
    await run(
        "a{ transition-duration: spring-duration(77) }", 
        "a{ transition-duration: calc(77ms * var(--_spring-duration-multiplier-0)) }", 
        {}
    );
});

test("handles transition with spring-duration and spring-bounce", async () => {
    await run(
        ".my-box { transition: transform spring-duration(200) spring-bounce(30); }",
        ".my-box { transition: transform calc(200ms * var(--_spring-duration-multiplier-0)) linear(0, 0.0018, 0.0069, 0.0151 1.74%, 0.0277 2.4%, 0.062 3.7%, 0.1115 5.15%, 0.2211 7.77%, 0.4778 13.21%, 0.5912 15.75%, 0.6987 18.44%, 0.7862 20.98%, 0.861 23.59%, 0.8926, 0.9205, 0.945 27.51%, 0.9671 28.89%, 0.9868, 1.003 31.79%, 1.0224 34.11%, 1.0358 36.58%, 1.0436 39.27%, 1.046 42.31%, 1.0446 44.71%, 1.0406 47.47%, 1.0118 61.84%, 1.0027 69.53%, 0.9981 80.49%, 0.9991 99.94%); --_spring-duration-multiplier-0: 1.66; }",
        {}
    );
});

test("handles animation with spring-duration and spring-bounce", async () => {
    await run(
        ".my-box { animation: my-animation spring-duration(200) spring-bounce(30); }",
        ".my-box { animation: my-animation calc(200ms * var(--_spring-duration-multiplier-0)) linear(0, 0.0018, 0.0069, 0.0151 1.74%, 0.0277 2.4%, 0.062 3.7%, 0.1115 5.15%, 0.2211 7.77%, 0.4778 13.21%, 0.5912 15.75%, 0.6987 18.44%, 0.7862 20.98%, 0.861 23.59%, 0.8926, 0.9205, 0.945 27.51%, 0.9671 28.89%, 0.9868, 1.003 31.79%, 1.0224 34.11%, 1.0358 36.58%, 1.0436 39.27%, 1.046 42.31%, 1.0446 44.71%, 1.0406 47.47%, 1.0118 61.84%, 1.0027 69.53%, 0.9981 80.49%, 0.9991 99.94%); --_spring-duration-multiplier-0: 1.66; }",
        {}
    );
});

test("handles multiple transition values", async () => {
    await run(
        ".my-box { transition: transform spring-duration(200) spring-bounce(0), scale spring-duration(400) spring-bounce(70); }",
        ".my-box { transition: transform calc(200ms * var(--_spring-duration-multiplier-0)) linear(0, 0.001 0.44%, 0.0045 0.94%, 0.0195 2.03%, 0.0446 3.19%, 0.0811 4.5%, 0.1598 6.82%, 0.3685 12.34%, 0.4693 15.17%, 0.5663, 0.6498 21.27%, 0.7215 24.39%, 0.7532 25.98%, 0.7829 27.65%, 0.8105, 0.8349 31.14%, 0.8573 32.95%, 0.8776 34.84%, 0.8964 36.87%, 0.9136 39.05%, 0.929 41.37%, 0.9421 43.77%, 0.9537 46.38%, 0.9636 49.14%, 0.9789 55.31%, 0.9888 62.35%, 0.9949 71.06%, 0.9982 82.52%, 0.9997 99.94%), scale calc(400ms * var(--_spring-duration-multiplier-1)) linear(0, 0.0029, 0.0115, 0.0255, 0.0453, 0.0714, 0.1025 1.95%, 0.1844 2.68%, 0.2681 3.31%, 0.371 4%, 0.768 6.45%, 0.919, 1.054 8.41%, 1.1624 9.34%, 1.208, 1.247, 1.2816, 1.3097, 1.3325, 1.3504, 1.3629, 1.3702 12.98%, 1.3722, 1.3716, 1.3683, 1.3625 14.36%, 1.3431 15.1%, 1.3123 15.89%, 1.2805 16.56%, 1.2392 17.32%, 1.0838 19.9%, 1.0257, 0.9748 21.93%, 0.9348 22.87%, 0.9056, 0.884, 0.8696, 0.8624 26.32%, 0.8614, 0.8635 27.54%, 0.8686 28.18%, 0.877 28.86%, 0.8882 29.57%, 0.9029 30.34%, 0.9824 33.93%, 1.0156 35.7%, 1.0299 36.7%, 1.0404, 1.0475, 1.0511 39.64%, 1.0509 40.89%, 1.0459 42.26%, 1.036 43.76%, 1.0067 47.32%, 0.9945 49.06%, 0.9852, 0.9811 52.93%, 0.9829 55.66%, 1.0019 62.39%, 1.007 66.13%, 1.0064 69.05%, 0.9994 75.69%, 0.9974 79.29%, 1.0009 91.8%, 1.0003 100%); --_spring-duration-multiplier-0: 1.66; --_spring-duration-multiplier-1: 3.91; }",
        {}
    );
});

test("handles separate transition-duration and transition-timing-function", async () => {
    await run(
        ".my-box { transition-duration: spring-duration(200), spring-duration(200); transition-property: transform, scale; transition-timing-function: spring-bounce(0), spring-bounce(70); }",
        ".my-box { transition-duration: calc(200ms * var(--_spring-duration-multiplier-0)), calc(200ms * var(--_spring-duration-multiplier-1)); transition-property: transform, scale; transition-timing-function: linear(0, 0.001 0.44%, 0.0045 0.94%, 0.0195 2.03%, 0.0446 3.19%, 0.0811 4.5%, 0.1598 6.82%, 0.3685 12.34%, 0.4693 15.17%, 0.5663, 0.6498 21.27%, 0.7215 24.39%, 0.7532 25.98%, 0.7829 27.65%, 0.8105, 0.8349 31.14%, 0.8573 32.95%, 0.8776 34.84%, 0.8964 36.87%, 0.9136 39.05%, 0.929 41.37%, 0.9421 43.77%, 0.9537 46.38%, 0.9636 49.14%, 0.9789 55.31%, 0.9888 62.35%, 0.9949 71.06%, 0.9982 82.52%, 0.9997 99.94%), linear(0, 0.0029, 0.0115, 0.0255, 0.0453, 0.0714, 0.1025 1.95%, 0.1844 2.68%, 0.2681 3.31%, 0.371 4%, 0.768 6.45%, 0.919, 1.054 8.41%, 1.1624 9.34%, 1.208, 1.247, 1.2816, 1.3097, 1.3325, 1.3504, 1.3629, 1.3702 12.98%, 1.3722, 1.3716, 1.3683, 1.3625 14.36%, 1.3431 15.1%, 1.3123 15.89%, 1.2805 16.56%, 1.2392 17.32%, 1.0838 19.9%, 1.0257, 0.9748 21.93%, 0.9348 22.87%, 0.9056, 0.884, 0.8696, 0.8624 26.32%, 0.8614, 0.8635 27.54%, 0.8686 28.18%, 0.877 28.86%, 0.8882 29.57%, 0.9029 30.34%, 0.9824 33.93%, 1.0156 35.7%, 1.0299 36.7%, 1.0404, 1.0475, 1.0511 39.64%, 1.0509 40.89%, 1.0459 42.26%, 1.036 43.76%, 1.0067 47.32%, 0.9945 49.06%, 0.9852, 0.9811 52.93%, 0.9829 55.66%, 1.0019 62.39%, 1.007 66.13%, 1.0064 69.05%, 0.9994 75.69%, 0.9974 79.29%, 1.0009 91.8%, 1.0003 100%); --_spring-duration-multiplier-0: 1.66; --_spring-duration-multiplier-1: 3.91; }",
        {}
    );
});
